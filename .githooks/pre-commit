#!/usr/bin/env sh
# Git pre-commit hook wrapper that runs the PowerShell sync+validation script
ROOT_DIR="$(git rev-parse --show-toplevel)"
echo "Running OAuth sync+validation..."
pwsh -NoProfile -ExecutionPolicy Bypass -File "$ROOT_DIR/scripts/sync-root-env-to-web.ps1"
REPORT="$ROOT_DIR/oauth-validation-report.json"
if [ ! -f "$REPORT" ]; then
  echo "OAuth validation report not found ($REPORT)" >&2
  exit 1
fi

# Validate JSON using PowerShell (cross-platform)
pwsh -NoProfile -ExecutionPolicy Bypass -Command "& { $r = Get-Content '$REPORT' | ConvertFrom-Json; if (-not $r.clientSecretPresent -or -not $r.clientIdFormatValid -or -not $r.redirectsValid -or ($r.gcloudInstalled -and -not $r.gcloudClientMatch)) { Write-Host '❌ OAuth validation failed'; exit 1 } else { Write-Host '✔ OAuth validation passed'; exit 0 } }"
